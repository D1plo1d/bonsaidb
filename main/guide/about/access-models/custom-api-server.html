<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Custom Api Server - BonsaiDb User&#x27;s Guide</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">About BonsaiDb</li><li class="chapter-item expanded "><a href="../../about/concepts.html"><strong aria-hidden="true">1.</strong> Concepts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../about/concepts/document.html"><strong aria-hidden="true">1.1.</strong> Document</a></li><li class="chapter-item expanded "><a href="../../about/concepts/collection.html"><strong aria-hidden="true">1.2.</strong> Collection</a></li><li class="chapter-item expanded "><a href="../../about/concepts/view.html"><strong aria-hidden="true">1.3.</strong> View</a></li><li class="chapter-item expanded "><a href="../../about/concepts/schema.html"><strong aria-hidden="true">1.4.</strong> Schema</a></li><li class="chapter-item expanded "><a href="../../about/concepts/database.html"><strong aria-hidden="true">1.5.</strong> Database</a></li><li class="chapter-item expanded "><a href="../../about/concepts/storage.html"><strong aria-hidden="true">1.6.</strong> Storage</a></li><li class="chapter-item expanded "><a href="../../about/concepts/pubsub.html"><strong aria-hidden="true">1.7.</strong> PubSub</a></li></ol></li><li class="chapter-item expanded "><a href="../../about/access_models.html"><strong aria-hidden="true">2.</strong> How can BonsaiDb be accessed?</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../about/access-models/custom-api-server.html" class="active"><strong aria-hidden="true">2.1.</strong> Custom Api Server</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Integration</li><li class="chapter-item expanded "><a href="../../integration/overview.html"><strong aria-hidden="true">3.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../../integration/async.html"><strong aria-hidden="true">4.</strong> Async vs Blocking</a></li><li class="chapter-item expanded "><a href="../../integration/local.html"><strong aria-hidden="true">5.</strong> Local</a></li><li class="chapter-item expanded "><a href="../../integration/server.html"><strong aria-hidden="true">6.</strong> Networked</a></li><li class="chapter-item expanded "><a href="../../integration/cluster.html"><strong aria-hidden="true">7.</strong> Clustered (upcoming)</a></li><li class="chapter-item expanded affix "><li class="part-title">Core Traits</li><li class="chapter-item expanded "><a href="../../traits/connection.html"><strong aria-hidden="true">8.</strong> Connection</a></li><li class="chapter-item expanded "><a href="../../traits/storage_connection.html"><strong aria-hidden="true">9.</strong> StorageConnection</a></li><li class="chapter-item expanded "><a href="../../traits/pubsub.html"><strong aria-hidden="true">10.</strong> PubSub</a></li><li class="chapter-item expanded "><a href="../../traits/key-value.html"><strong aria-hidden="true">11.</strong> KeyValue</a></li><li class="chapter-item expanded "><a href="../../traits/key.html"><strong aria-hidden="true">12.</strong> Key</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../traits/key/enum.html"><strong aria-hidden="true">12.1.</strong> Using an Enum as a Key</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Administration</li><li class="chapter-item expanded "><a href="../../administration/configuration.html"><strong aria-hidden="true">13.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="../../administration/permissions.html"><strong aria-hidden="true">14.</strong> Permissions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../administration/permission-statements.html"><strong aria-hidden="true">14.1.</strong> Permission Statements</a></li><li class="chapter-item expanded "><a href="../../administration/rbac.html"><strong aria-hidden="true">14.2.</strong> Users, Groups, and Roles</a></li></ol></li><li class="chapter-item expanded "><a href="../../administration/encryption.html"><strong aria-hidden="true">15.</strong> At-Rest Encryption</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">BonsaiDb User&#x27;s Guide</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="custom-api-server"><a class="header" href="#custom-api-server">Custom Api Server</a></h1>
<p>The <a href="https://dev.bonsaidb.io/main/docs/bonsaidb/core/api/trait.Api.html"><code>Api</code></a> trait defines two associated types, Response, and Error. The <code>Api</code> type is akin to a &quot;request&quot; that the server receives. The server will invoke a <a href="https://dev.bonsaidb.io/main/docs/bonsaidb/server/api/trait.Handler.html"><code>Handler</code></a>, expecting a result with the associated Response and Error types.</p>
<blockquote>
<p>All code on this page comes from this example: <a href="https://github.com/khonsulabs/bonsaidb/blob/main/examples/basic-server/examples/custom-api.rs"><code>examples/basic-server/examples/custom-api.rs</code></a>.</p>
</blockquote>
<p>This example defines two Api types with associated output types, but uses BonsaiDb's <a href="https://dev.bonsaidb.io/main/docs/bonsaidb/core/api/enum.Infallible.html"><code>Infallible</code></a> type for the Error associated type:</p>
<pre><code class="language-rust noplayground no_run">#[derive(Serialize, Deserialize, Debug)]
pub struct Ping;

impl Api for Ping {
    type Error = Infallible;
    type Response = Pong;

    fn name() -&gt; ApiName {
        ApiName::private(&quot;ping&quot;)
    }
}

#[derive(Serialize, Deserialize, Debug, Clone)]
pub struct Pong;

#[derive(Serialize, Deserialize, Debug)]
pub struct IncrementCounter {
    amount: u64,
}

impl Api for IncrementCounter {
    type Error = Infallible;
    type Response = Counter;

    fn name() -&gt; ApiName {
        ApiName::private(&quot;increment&quot;)
    }
}

#[derive(Serialize, Deserialize, Debug, Clone)]
pub struct Counter(pub u64);</code></pre>
<p>To implement the server, we must define a <a href="https://dev.bonsaidb.io/main/docs/bonsaidb/server/api/trait.Handler.html"><code>Handler</code></a>, which is invoked each time the <code>Api</code> type is received by the server.</p>
<pre><code class="language-rust noplayground no_run">impl Backend for ExampleBackend {
    type ClientData = ();
    type Error = Infallible;
}

/// Dispatches Requests and returns Responses.
#[derive(Debug)]
pub struct ExampleHandler;

/// The Request::Ping variant has `#[actionable(protection = &quot;none&quot;)]`, which
/// causes `PingHandler` to be generated with a single method and no implicit
/// permission handling.
#[async_trait]
impl Handler&lt;ExampleBackend, Ping&gt; for ExampleHandler {
    async fn handle(
        _session: HandlerSession&lt;'_, ExampleBackend&gt;,
        _request: Ping,
    ) -&gt; HandlerResult&lt;Ping&gt; {
        Ok(Pong)
    }
}</code></pre>
<p>Finally, the client can issue the API call and receive the response, without needing any extra steps to serialize. This works regardless of whether the client is connected via QUIC or WebSockets.</p>
<pre><code class="language-rust noplayground no_run">async fn ping_the_server(client: &amp;Client, client_name: &amp;str) -&gt; Result&lt;(), bonsaidb::core::Error&gt; {
    match client.send_api_request_async(&amp;Ping).await {
        Ok(Pong) =&gt; {
            println!(&quot;Received Pong from server on {}&quot;, client_name);
        }
        other =&gt; println!(
            &quot;Unexpected response from API call on {}: {:?}&quot;,
            client_name, other
        ),
    }

    Ok(())
}</code></pre>
<h2 id="permissions"><a class="header" href="#permissions">Permissions</a></h2>
<p>One of the strengths of using BonsaiDb's custom api functionality is the ability to tap into the permissions handling that BonsaiDb uses. The Ping request has no permissions, but let's add permission handling to our <code>IncrementCounter</code> API. We will do this by creating an <code>increment_counter</code> function that expects two parameters: a connection to the storage layer with unrestricted permissions, and a second connection to the storage layer which has been restricted to the permissions the client invoking it is authorized to perform:</p>
<pre><code class="language-rust noplayground no_run">/// The permissible actions that can be granted for this example api.
#[derive(Debug, Action)]
#[action(actionable = bonsaidb::core::actionable)]
pub enum ExampleActions {
    Increment,
    DoSomethingCustom,
}

pub async fn increment_counter&lt;S: AsyncStorageConnection&lt;Database = C&gt;, C: AsyncKeyValue&gt;(
    storage: &amp;S,
    as_client: &amp;S,
    amount: u64,
) -&gt; Result&lt;u64, bonsaidb::core::Error&gt; {
    as_client.check_permission([Identifier::from(&quot;increment&quot;)], &amp;ExampleActions::Increment)?;
    let database = storage.database::&lt;()&gt;(&quot;counter&quot;).await?;
    database.increment_key_by(&quot;counter&quot;, amount).await
}

#[async_trait]
impl Handler&lt;ExampleBackend, IncrementCounter&gt; for ExampleHandler {
    async fn handle(
        session: HandlerSession&lt;'_, ExampleBackend&gt;,
        request: IncrementCounter,
    ) -&gt; HandlerResult&lt;IncrementCounter&gt; {
        Ok(Counter(
            increment_counter(session.server, &amp;session.as_client, request.amount).await?,
        ))
    }
}</code></pre>
<p>The <a href="https://dev.bonsaidb.io/main/docs/bonsaidb/server/api/trait.Handler.html"><code>Handler</code></a> is provided a <a href="https://dev.bonsaidb.io/main/docs/bonsaidb/server/api/struct.HandlerSession.html"><code>HandlerSession</code></a> as well as the <code>Api</code> type, which provides all the context information needed to verify the connected client's authenticated identity and permissions. Additionally, it provides two ways to access the storage layer: with unrestricted permissions or restricted to the permissions granted to the client.</p>
<p>Let's finish configuring the server to allow all unauthenticated users the abilty to <code>Ping</code>, and all authenticated users the ability to <code>Increment</code> the counter:</p>
<pre><code class="language-rust noplayground no_run">    let server = CustomServer::&lt;ExampleBackend&gt;::open(
        ServerConfiguration::new(&quot;custom-api.bonsaidb&quot;)
            .default_permissions(Permissions::from(
                Statement::for_any()
                    .allowing(&amp;BonsaiAction::Server(ServerAction::Connect))
                    .allowing(&amp;BonsaiAction::Server(ServerAction::Authenticate(
                        AuthenticationMethod::PasswordHash,
                    ))),
            ))
            .authenticated_permissions(Permissions::from(vec![
                Statement::for_any().allowing(&amp;ExampleActions::Increment)
            ]))
            .with_api::&lt;ExampleHandler, Ping&gt;()?
            .with_api::&lt;ExampleHandler, IncrementCounter&gt;()?
            .with_schema::&lt;()&gt;()?,
    )
    .await?;</code></pre>
<p>For more information on managing permissions, <a href="../../administration/permissions.html">see Administration/Permissions</a>.</p>
<p>The full example these snippets are taken from is <a href="https://github.com/khonsulabs/bonsaidb/blob/main/examples/basic-server/examples/custom-api.rs">available in the repository</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../about/access_models.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../integration/overview.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../about/access_models.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../integration/overview.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../mermaid.min.js"></script>
        <script src="../../mermaid-init.js"></script>


    </body>
</html>
